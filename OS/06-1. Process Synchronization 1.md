# 운영체제 강의 정리

## 06-1. Process Synchronization

### 데이터의 접근

1. Data에 저장되어있는 storage
2. storage에서 연산할 data를 읽어옴
3. Execution box에서 연산함
4. 연산된 결과를 storage에 저장

Storage : Memory, 디스크, 프로세스 주소 공간

Execution box : CPU, 컴퓨터 내부, 프로세스

누가 언제 데이터를 읽어갔느냐에 따라 결과값이 달라질 수 있음

### Race Condition

Storage를 공유하는 Execution box가 여러개 인 경우 Race Condition의 가능성

- Multiprocessor system에서.
- 공유 메모리를 사용하는 프로세스들 사이에서.
- 커널 내부 데이터를 접근하는 루틴들 사이에서.



### OS에서 race condition은 언제 발생하는가

1. kernel 수행 중 인터럽트 발생 시
2. Process가 system call하여 kernel mode로 수행 중인데 context switch가 일어나는 경우
3. Multiprocessor에서 공유 메모리 내의 kernel data



#### 1. interrupt handler vs kernel

예시

커널에서 count++ 코드 수행 중

세 가지 과정

1. data load
2. increase
3. data store

근데 1. 까지 하고 interrupt 발생, 인터럽트 처리 루틴 수행, 양쪽 다 커널 코드이므로 kernel address space 공유

인터럽트 처리 루틴은 count--

인터럽트 처리 후 다시 kernel로 돌아왔을 때, 1.에서 load한 데이터를 그대로 사용하므로, count--가 적용이 되지 않음.

**해결**

중요한 데이터로 작업할 때는 interrupt가 중간에 들어와도 해당 작업이 모두 끝난 후 interrupt 처리 루틴으로 넘김.



#### 2. Preempt a process running in kernel

프로세스 A가 실행 중이다가 system call해서 kernel모드로 진입.

커널 모드 수행 중 time interrupt로 프로세스 B에서 preempt

프로세스 B 실행 후 다시 프로세스 A로 돌아가면?

**해결**

커널 모드 수행 중일 때는 CPU preempt하지 않음

커널 모드에서 사용자 모드로 돌아갈 때 preempt



#### 3. Multiprocessor

방법 1 : 한번에 하나의 CPU만 커널에 들어갈 수 있게

방법 2 : 커널 내부에 있는 각 공유 데이터에 접근할 때마다 그 데이터에 lock/unlock



### Processor Synchronization 문제

공유 데이터의 동시 접근은 데이터의 불일치 문제를 발생시킬 수 있음

일관성 유지를 위해 협력 프로세스 간의 실행 순서를 정해주는 메커니즘 필요

**Race condition**

- 여러 프로세스들이 동시에 공유 데이터를 접근하는 상황
- 데이터의 최종 연산 결과는 마지막에 그 데이터를 다룬 프로세스에 따라 달라짐

race condition을 막기 위해서는 concurrent process는 동기화(synchronization)되어야함



### The Criticla-Section Problem

n 개의 프로세스가 공유 데이터를 동시에 사용하기를 원하는 경우

각 프로세스의 code segment에는 공유 데이터를 접근하는 코드는 **critical section** 존재

**해결해야하는 문제**

- 하나의 프로세스가 critical section에 있을 때 다른 모든 프로세스는 critical section에 들어갈 수 없어야 한다.



### Initial Attempts to Solve Problem

- 두 개의 프로세스가 있다고 가정 P0, P1

- 프로세스의 일반적인 구조는 다음과 같음

  ```C
  do {
      entry section
      critical section
      exit section
      remainder section
  } while(1);
  ```

  크리티컬 섹션과 그렇지 않은 섹션

- 프로세스들은 수행의 동기화를 위해 몇몇 변수를 공유할 수 있다

  => synchronization variable